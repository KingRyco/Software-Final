<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ReelDeal Cinema - Admin Panel</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/feather-icons"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
    * { font-family: 'Inter', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
    body { 
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
    }
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
            radial-gradient(circle at 80% 80%, rgba(255, 138, 101, 0.3) 0%, transparent 50%);
        pointer-events: none;
        z-index: 0;
    }
    .glass { 
        background: rgba(255,255,255,0.95); 
        backdrop-filter: blur(10px); 
        border: 1px solid rgba(255,255,255,0.3); 
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    .btn-primary { 
        background: linear-gradient(135deg, #4a90e2 0%, #7877c6 100%); 
        color:white; 
        font-weight:bold; 
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(74, 144, 226, 0.4);
    }
    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        font-weight: bold;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }
    .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        font-weight: bold;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }
    .stat-card {
        background: linear-gradient(135deg, #4a90e2 0%, #7877c6 100%);
        color: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    table { 
        border-collapse: collapse; 
        width: 100%;
        color: black;
    }
    th, td { 
        border: 1px solid #ddd; 
        padding: 12px; 
        text-align: left;
        vertical-align: top;
    }
    th { 
        background: linear-gradient(135deg, #4a90e2 0%, #7877c6 100%);
        color: white;
        font-weight: 600;
    }
    tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    tr:hover {
        background-color: #e8f0fe;
    }
    .fade-in {
        animation: fadeIn 0.8s ease-in;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .btn-outline {
        padding: 0.5rem 1rem;
        margin: 0 0.25rem;
        border-radius: 0.5rem;
        background: white;
        border: 2px solid #4a90e2;
        color: #4a90e2;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .pagination-btn:hover {
        background: #4a90e2;
        color: white;
    }
    .pagination-btn.active {
        background: #4a90e2;
        color: white;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        backdrop-filter: blur(5px);
    }
    .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
    }
    .sync-notice {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        text-align: center;
        font-weight: 600;
    }
</style>
</head>
<body>

<!-- Main Admin Panel -->
<main id="adminPanel" class="container mx-auto px-4 py-8 relative z-10 fade-in">

<header class="mb-8 text-center text-white">
    <h1 class="text-5xl font-black mb-2">üé¨ ReelDeal Cinema - Admin Panel</h1>
    <p class="text-lg opacity-90">Comprehensive analytics and management</p>
    <div class="sync-notice mt-4">
        ‚úÖ All changes sync automatically with SQL database and home screen<br>
        <span class="text-sm">üîí Admin-only access: Only accounts with admin privileges can access this panel and create other admins</span>
    </div>
</header>

<nav class="flex flex-wrap justify-center gap-4 mb-12">
    <button class="btn-primary px-6 py-3 rounded-xl" onclick="showSection('dashboard')">üìä Dashboard</button>
    <button class="btn-primary px-6 py-3 rounded-xl" onclick="showSection('ticketHistory')">üé´ All Tickets</button>
    <button class="btn-primary px-6 py-3 rounded-xl" onclick="showSection('movieRevenue')">üí∞ Movie Revenue</button>
    <button class="btn-primary px-6 py-3 rounded-xl" onclick="showSection('theaterAnalytics')">üè¢ Theater Analytics</button>
    <button class="btn-primary px-6 py-3 rounded-xl" onclick="showSection('timeAnalytics')">‚è∞ Showtime Analytics</button>
    <button class="btn-primary px-6 py-3 rounded-xl" onclick="showSection('manageTheaters')">üè™ Manage Theaters</button>
    <button class="btn-primary px-6 py-3 rounded-xl" onclick="showSection('manageAdmins')">üëë Manage Admins</button>
    <button class="btn-primary px-6 py-3 rounded-xl" onclick="showSection('registeredUsers')">üë• Registered Users</button>
    <button class="btn-danger px-6 py-3 rounded-xl" onclick="window.location.href='login.html'">üö™ Logout</button>
</nav>

<!-- Dashboard Section -->
<section id="dashboard" class="space-y-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold text-white">üìä Dashboard Overview</h2>
        <button onclick="exportData()" class="btn-success px-6 py-3 rounded-xl">üì• Export Report (CSV)</button>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="stat-card">
            <div class="text-4xl mb-2">üé´</div>
            <div class="text-3xl font-black" id="totalTickets">0</div>
            <div class="text-sm opacity-90">Total Tickets Sold</div>
        </div>
        
        <div class="stat-card">
            <div class="text-4xl mb-2">üí∞</div>
            <div class="text-3xl font-black">$<span id="totalRevenue">0.00</span></div>
            <div class="text-sm opacity-90">Total Revenue</div>
        </div>
        
        <div class="stat-card">
            <div class="text-4xl mb-2">üé¨</div>
            <div class="text-3xl font-black" id="uniqueMovies">0</div>
            <div class="text-sm opacity-90">Movies Sold</div>
        </div>
        
        <div class="stat-card">
            <div class="text-4xl mb-2">üí≥</div>
            <div class="text-3xl font-black">$<span id="avgTicketPrice">0.00</span></div>
            <div class="text-sm opacity-90">Avg Ticket Price</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="glass p-6 rounded-xl shadow-lg">
            <h3 class="text-2xl font-bold mb-4 text-gray-900">Revenue by Movie</h3>
            <div class="chart-container">
                <canvas id="movieRevenueChart"></canvas>
            </div>
        </div>
        
        <div class="glass p-6 rounded-xl shadow-lg">
            <h3 class="text-2xl font-bold mb-4 text-gray-900">Theater Performance</h3>
            <div class="chart-container">
                <canvas id="theaterChart"></canvas>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="glass p-6 rounded-xl shadow-lg">
            <h3 class="text-2xl font-bold mb-4 text-gray-900">Showtime Distribution</h3>
            <div class="chart-container">
                <canvas id="showtimeChart"></canvas>
            </div>
        </div>
        
        <div class="glass p-6 rounded-xl shadow-lg">
            <h3 class="text-2xl font-bold mb-4 text-gray-900">Payment Methods</h3>
            <div class="chart-container">
                <canvas id="paymentChart"></canvas>
            </div>
        </div>
    </div>

    <div class="glass p-6 rounded-xl shadow-lg">
        <h3 class="text-2xl font-bold mb-4 text-gray-900">Top Performing Movies</h3>
        <div id="topMovies" class="space-y-3"></div>
    </div>
</section>

<!-- All Tickets Section -->
<section id="ticketHistory" class="hidden space-y-6">
    <h2 class="text-3xl font-bold text-white mb-6">üé´ Complete Ticket History</h2>
    
    <div class="flex flex-wrap gap-4 mb-4">
        <input type="text" id="searchTicket" placeholder="Search by movie, theater, or ticket ID..." class="p-3 rounded-xl flex-1 min-w-[250px]">
        <select id="filterTheaterTicket" class="p-3 rounded-xl">
            <option value="">All Theaters</option>
        </select>
        <select id="filterShowtimeTicket" class="p-3 rounded-xl">
            <option value="">All Showtimes</option>
        </select>
        <button class="btn-primary px-6 py-3 rounded-xl" onclick="renderTickets()">üîç Search</button>
        <button class="btn-primary px-6 py-3 rounded-xl" onclick="clearTicketFilters()">Clear</button>
    </div>
    
    <div class="glass p-6 rounded-xl shadow-lg">
        <div id="ticketHistoryContainer"></div>
        <div id="ticketPagination" class="flex justify-center mt-6 flex-wrap"></div>
    </div>
</section>

<!-- Movie Revenue Section -->
<section id="movieRevenue" class="hidden space-y-6">
    <h2 class="text-3xl font-bold text-white mb-6">üí∞ Movie Revenue Breakdown</h2>
    
    <div class="glass p-6 rounded-xl shadow-lg overflow-x-auto">
        <div id="movieRevenueContainer"></div>
    </div>
</section>

<!-- Theater Analytics Section -->
<section id="theaterAnalytics" class="hidden space-y-6">
    <h2 class="text-3xl font-bold text-white mb-6">üè¢ Theater Analytics</h2>
    
    <div class="glass p-6 rounded-xl shadow-lg overflow-x-auto">
        <div id="theaterAnalyticsContainer"></div>
    </div>
</section>

<!-- Time Analytics Section -->
<section id="timeAnalytics" class="hidden space-y-6">
    <h2 class="text-3xl font-bold text-white mb-6">‚è∞ Showtime Analytics</h2>
    
    <div class="glass p-6 rounded-xl shadow-lg overflow-x-auto">
        <div id="timeAnalyticsContainer"></div>
    </div>
</section>

<!-- Manage Theaters Section -->
<section id="manageTheaters" class="hidden space-y-6">
    <h2 class="text-3xl font-bold text-white mb-6">üè™ Manage Theaters & Showtimes</h2>
    
    <div class="glass p-6 rounded-xl shadow-lg mb-6">
        <h3 class="text-xl font-bold mb-4 text-gray-900">Add New Theater</h3>
        <div class="flex gap-4">
            <input type="text" id="newTheaterName" placeholder="Theater Name *" class="p-3 rounded-xl border-2 border-gray-300 flex-1">
            <button onclick="addTheater()" class="btn-success px-6 py-3 rounded-xl">Add Theater</button>
        </div>
    </div>
    
    <div class="glass p-6 rounded-xl shadow-lg mb-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-900">Current Theaters</h3>
            <input type="text" id="searchTheaters" placeholder="Search theaters..." class="p-2 rounded-lg border-2 border-gray-300 w-64" oninput="renderTheatersList()">
        </div>
        <div id="theatersListContainer" class="space-y-3"></div>
    </div>
    
    <div class="glass p-6 rounded-xl shadow-lg">
        <h3 class="text-xl font-bold mb-4 text-gray-900">Add New Showtime</h3>
        <div class="flex gap-4">
            <input type="text" id="newShowtimeName" placeholder="Showtime Name (e.g., Late Night) *" class="p-3 rounded-xl border-2 border-gray-300 flex-1">
            <input type="text" id="newShowtimeTime" placeholder="Time (e.g., 9:00 PM) *" class="p-3 rounded-xl border-2 border-gray-300 flex-1">
            <button onclick="addShowtime()" class="btn-success px-6 py-3 rounded-xl">Add Showtime</button>
        </div>
    </div>
    
    <div class="glass p-6 rounded-xl shadow-lg mt-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-900">Current Showtimes</h3>
            <input type="text" id="searchShowtimes" placeholder="Search showtimes..." class="p-2 rounded-lg border-2 border-gray-300 w-64" oninput="renderShowtimesList()">
        </div>
        <div id="showtimesListContainer" class="space-y-3"></div>
    </div>
</section>

<!-- Manage Admins Section -->
<section id="manageAdmins" class="hidden space-y-6">
    <h2 class="text-3xl font-bold text-white mb-6">üëë Manage Admins</h2>
    
    <div class="glass p-6 rounded-xl shadow-lg mb-6">
        <h3 class="text-xl font-bold mb-4 text-gray-900">Promote User to Admin</h3>
        <p class="text-sm text-gray-600 mb-4">Select a registered user to promote to admin status</p>
        <div class="flex gap-4">
            <select id="promoteUserSelect" class="p-3 rounded-xl border-2 border-gray-300 flex-1">
                <option value="">Select a user to promote...</option>
            </select>
            <button onclick="promoteToAdmin()" class="btn-success px-6 py-3 rounded-xl">Promote to Admin</button>
        </div>
    </div>
    
    <div class="glass p-6 rounded-xl shadow-lg mb-6">
        <h3 class="text-xl font-bold mb-4 text-gray-900">Create New Admin Account</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="text" id="newAdminName" placeholder="Full Name *" class="p-3 rounded-xl border-2 border-gray-300">
            <input type="email" id="newAdminEmail" placeholder="Email *" class="p-3 rounded-xl border-2 border-gray-300">
            <input type="password" id="newAdminPassword" placeholder="Password *" class="p-3 rounded-xl border-2 border-gray-300">
            <input type="text" id="newAdminPhone" placeholder="Phone (555-123-4567)" class="p-3 rounded-xl border-2 border-gray-300">
        </div>
        <button onclick="addAdmin()" class="btn-success px-6 py-3 rounded-xl mt-4">Create Admin Account</button>
    </div>
    
    <div class="glass p-6 rounded-xl shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-900">Current Admins (<span id="adminCount">0</span>)</h3>
            <input type="text" id="searchAdmins" placeholder="Search admins..." class="p-2 rounded-lg border-2 border-gray-300 w-64" oninput="renderAdminsList()">
        </div>
        <div id="adminsListContainer" class="space-y-4"></div>
    </div>
</section>

<!-- Registered Users Section -->
<section id="registeredUsers" class="hidden space-y-6">
    <h2 class="text-3xl font-bold text-white mb-6">üë• Registered Users</h2>
    
    <div class="glass p-6 rounded-xl shadow-lg mb-6">
        <h3 class="text-xl font-bold mb-4 text-gray-900">Add New User</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="text" id="newUserName" placeholder="Full Name *" class="p-3 rounded-xl border-2 border-gray-300">
            <input type="email" id="newUserEmail" placeholder="Email *" class="p-3 rounded-xl border-2 border-gray-300">
            <input type="password" id="newUserPassword" placeholder="Password *" class="p-3 rounded-xl border-2 border-gray-300">
            <input type="text" id="newUserPhone" placeholder="Phone (555-123-4567)" class="p-3 rounded-xl border-2 border-gray-300">
        </div>
        <button onclick="addUser()" class="btn-success px-6 py-3 rounded-xl mt-4">Add User</button>
    </div>
    
    <div class="glass p-6 rounded-xl shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-900">Registered Users List (<span id="userCount">0</span>)</h3>
            <input type="text" id="searchUsers" placeholder="Search users..." class="p-2 rounded-lg border-2 border-gray-300 w-64" oninput="renderUsersList()">
        </div>
        <div id="usersListContainer" class="space-y-4"></div>
    </div>
</section>

</main>

<!-- Edit User Modal -->
<div id="editUserModal" class="modal">
    <div class="modal-content">
        <h2 class="text-2xl font-bold mb-4">Edit User</h2>
        <div class="space-y-4">
            <input type="hidden" id="editUserId">
            <input type="text" id="editUserName" placeholder="Full Name *" class="w-full p-3 rounded-xl border-2 border-gray-300">
            <input type="email" id="editUserEmail" placeholder="Email *" class="w-full p-3 rounded-xl border-2 border-gray-300">
            <input type="password" id="editUserPassword" placeholder="Password (leave blank to keep current)" class="w-full p-3 rounded-xl border-2 border-gray-300">
            <input type="text" id="editUserPhone" placeholder="Phone" class="w-full p-3 rounded-xl border-2 border-gray-300">
            <input type="text" id="editUserSignupDate" disabled class="w-full p-3 rounded-xl border-2 border-gray-300 bg-gray-100">
            <div class="flex gap-4 mt-4">
                <button onclick="saveUserEdit()" class="btn-success px-6 py-3 rounded-xl flex-1">Save</button>
                <button onclick="closeUserModal()" class="btn-danger px-6 py-3 rounded-xl flex-1">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Theater Modal -->
<div id="editTheaterModal" class="modal">
    <div class="modal-content">
        <h2 class="text-2xl font-bold mb-4">Edit Theater</h2>
        <div class="space-y-4">
            <input type="hidden" id="editTheaterId">
            <input type="text" id="editTheaterName" placeholder="Theater Name *" class="w-full p-3 rounded-xl border-2 border-gray-300">
            <div class="flex gap-4 mt-4">
                <button onclick="saveTheaterEdit()" class="btn-success px-6 py-3 rounded-xl flex-1">Save</button>
                <button onclick="closeTheaterModal()" class="btn-danger px-6 py-3 rounded-xl flex-1">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Showtime Modal -->
<div id="editShowtimeModal" class="modal">
    <div class="modal-content">
        <h2 class="text-2xl font-bold mb-4">Edit Showtime</h2>
        <div class="space-y-4">
            <input type="hidden" id="editShowtimeId">
            <input type="text" id="editShowtimeName" placeholder="Showtime Name *" class="w-full p-3 rounded-xl border-2 border-gray-300">
            <input type="text" id="editShowtimeTime" placeholder="Time *" class="w-full p-3 rounded-xl border-2 border-gray-300">
            <div class="flex gap-4 mt-4">
                <button onclick="saveShowtimeEdit()" class="btn-success px-6 py-3 rounded-xl flex-1">Save</button>
                <button onclick="closeShowtimeModal()" class="btn-danger px-6 py-3 rounded-xl flex-1">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
feather.replace();

// =============================================
// SQL DATABASE IMPLEMENTATION
// =============================================

let db = null;

// Initialize SQL.js database
async function initDatabase() {
    try {
        const SQL = await initSqlJs({
            locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
        });

        const savedDb = localStorage.getItem('reeldeal_database');
        if (savedDb) {
            const uint8Array = new Uint8Array(JSON.parse(savedDb));
            db = new SQL.Database(uint8Array);
            console.log('Admin: Database loaded from storage');
        } else {
            db = new SQL.Database();
            console.log('Admin: No database found - users need to register');
        }
        return true;
    } catch (error) {
        console.error('Admin: Database initialization error:', error);
        alert('Failed to load database. Please refresh the page.');
        return false;
    }
}

// Save database to localStorage
function saveDatabase() {
    try {
        const data = db.export();
        const buffer = Array.from(data);
        localStorage.setItem('reeldeal_database', JSON.stringify(buffer));
        return true;
    } catch (error) {
        console.error('Save database error:', error);
        return false;
    }
}

// Get all users from SQL database
function getAllUsersFromSQL() {
    try {
        const stmt = db.prepare('SELECT * FROM users ORDER BY created_at DESC');
        const users = [];
        while (stmt.step()) {
            const row = stmt.getAsObject();
            users.push({
                id: row.user_id,
                userId: row.user_id,
                name: row.name,
                email: row.email,
                phone: row.phone || '',
                address: row.address || '',
                passwordHash: row.password_hash,
                accountType: row.account_type,
                signupDate: row.signup_date
            });
        }
        stmt.free();
        return users;
    } catch (error) {
        console.error('Get all users error:', error);
        return [];
    }
}

// Get regular users only (account_type = 'user')
function getRegularUsers() {
    try {
        const stmt = db.prepare("SELECT * FROM users WHERE account_type = 'user' ORDER BY created_at DESC");
        const users = [];
        while (stmt.step()) {
            const row = stmt.getAsObject();
            users.push({
                id: row.user_id,
                userId: row.user_id,
                name: row.name,
                email: row.email,
                phone: row.phone || '',
                address: row.address || '',
                passwordHash: row.password_hash,
                accountType: row.account_type,
                signupDate: row.signup_date
            });
        }
        stmt.free();
        return users;
    } catch (error) {
        console.error('Get regular users error:', error);
        return [];
    }
}

// Get admin users only (account_type = 'admin')
function getAdminUsers() {
    try {
        const stmt = db.prepare("SELECT * FROM users WHERE account_type = 'admin' ORDER BY created_at DESC");
        const admins = [];
        while (stmt.step()) {
            const row = stmt.getAsObject();
            admins.push({
                id: row.user_id,
                userId: row.user_id,
                name: row.name,
                email: row.email,
                phone: row.phone || '',
                address: row.address || '',
                passwordHash: row.password_hash,
                accountType: row.account_type,
                signupDate: row.signup_date
            });
        }
        stmt.free();
        return admins;
    } catch (error) {
        console.error('Get admin users error:', error);
        return [];
    }
}

// Update user in SQL database
function updateUserInSQL(userId, updates) {
    try {
        const fields = [];
        const values = [];
        
        if (updates.name !== undefined) {
            fields.push('name = ?');
            values.push(updates.name);
        }
        if (updates.email !== undefined) {
            fields.push('email = ?');
            values.push(updates.email);
        }
        if (updates.phone !== undefined) {
            fields.push('phone = ?');
            values.push(updates.phone);
        }
        if (updates.address !== undefined) {
            fields.push('address = ?');
            values.push(updates.address);
        }
        if (updates.accountType !== undefined) {
            fields.push('account_type = ?');
            values.push(updates.accountType);
        }
        if (updates.passwordHash !== undefined) {
            fields.push('password_hash = ?');
            values.push(updates.passwordHash);
        }
        
        if (fields.length === 0) return false;
        
        values.push(userId);
        const sql = `UPDATE users SET ${fields.join(', ')} WHERE user_id = ?`;
        db.run(sql, values);
        saveDatabase();
        
        // Update localStorage backup
        exportUsersToLocalStorage();
        return true;
    } catch (error) {
        console.error('Update user error:', error);
        return false;
    }
}

// Delete user from SQL database
function deleteUserFromSQL(userId) {
    try {
        db.run('DELETE FROM users WHERE user_id = ?', [userId]);
        db.run('DELETE FROM purchase_history WHERE user_id = ?', [userId]);
        db.run('DELETE FROM reviews WHERE user_id = ?', [userId]);
        saveDatabase();
        
        // Update localStorage backup
        exportUsersToLocalStorage();
        return true;
    } catch (error) {
        console.error('Delete user error:', error);
        return false;
    }
}

// Insert new user into SQL database
function insertUserIntoSQL(userData) {
    try {
        const stmt = db.prepare(`
            INSERT INTO users (user_id, name, email, phone, address, password_hash, account_type, signup_date)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        `);
        stmt.run([
            userData.userId,
            userData.name,
            userData.email,
            userData.phone || '',
            userData.address || '',
            userData.passwordHash,
            userData.accountType,
            userData.signupDate
        ]);
        stmt.free();
        saveDatabase();
        
        // Update localStorage backup
        exportUsersToLocalStorage();
        return true;
    } catch (error) {
        console.error('Insert user error:', error);
        return false;
    }
}

// Check if email exists in SQL database
function emailExistsInSQL(email) {
    try {
        const stmt = db.prepare('SELECT email FROM users WHERE email = ?');
        stmt.bind([email.toLowerCase()]);
        const result = stmt.step();
        stmt.free();
        return result;
    } catch (error) {
        console.error('Email check error:', error);
        return false;
    }
}

// Export users to localStorage for backward compatibility
function exportUsersToLocalStorage() {
    try {
        const users = getAllUsersFromSQL();
        localStorage.setItem('registeredUsers', JSON.stringify(users));
        return users;
    } catch (error) {
        console.error('Export to localStorage error:', error);
        return [];
    }
}

// Utility functions
function hashPassword(password) {
    return CryptoJS.SHA256(password).toString();
}

function generateUserId() {
    return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// SHARED localStorage keys with home screen
const STORAGE_KEYS = {
    MOVIES: 'homeScreenCurrentMovies',
    THEATERS: 'homeScreenTheaters',
    SHOWTIMES: 'homeScreenShowtimes',
    TICKETS: 'ticketHistory',
    USERS: 'registeredUsers'
};

// Movie data with prices (for backwards compatibility)
let moviePrices = {
    "Dune: Part Two": 15.99,
    "The Batman": 14.99,
    "Everything Everywhere All at Once": 13.99,
    "Top Gun: Maverick": 14.50,
    "Avengers: Endgame": 16.99,
    "Avengers: Infinity War": 15.50,
    "The Avengers": 12.99,
    "X-Men: Days of Future Past": 13.50,
    "Spider-Man: Brand New Day": 17.99,
    "Avengers: Secret Wars": 18.99,
    "X-Men": 16.50,
    "The Batman: Part II": 17.50
};

// Default data
const defaultMovies = [
    {id:1, title:"Dune: Part Two", genre:"Sci-Fi", rating:4.8, price:15.99, image:"https://blog.teufelaudio.nl/wp-content/uploads/2024/02/dune-2-imago415303603-2.jpg", synopsis:"Epic sci-fi adventure continues.", cast:"Timoth√©e Chalamet, Zendaya", runtime:"2h 45m"},
    {id:2, title:"The Batman", genre:"Action", rating:4.6, price:14.99, image:"https://m.media-amazon.com/images/M/MV5BMDdmMTBiNTYtMDIzNi00NGVlLWIzMDYtZTk3MTQ3NGQxZGEwXkEyXkFqcGdeQXVyMzMwOTU5MDk@._V1_FMjpg_UX1000_.jpg", synopsis:"The Dark Knight returns.", cast:"Robert Pattinson, Zo√´ Kravitz", runtime:"2h 55m"},
    {id:3, title:"Everything Everywhere All at Once", genre:"Adventure", rating:4.9, price:13.99, image:"https://wallpapers.com/images/hd/everything-everywhere-all-at-once-6nyvo1vueb3ph27x.jpg", synopsis:"A multiverse story.", cast:"Michelle Yeoh, Ke Huy Quan", runtime:"2h 20m"},
    {id:4, title:"Top Gun: Maverick", genre:"Action", rating:4.7, price:14.50, image:"https://static1.srcdn.com/wordpress/wp-content/uploads/2022/05/top-gun-maverick.jpg", synopsis:"Return to the skies.", cast:"Tom Cruise, Miles Teller", runtime:"2h 11m"},
    {id:5, title:"Avengers: Endgame", genre:"Action", rating:4.9, price:16.99, image:"https://disney.images.edge.bamgrid.com/ripcut-delivery/v2/variant/disney/7b350a2f-0b3e-4033-8125-34c4d67e3bbe/compose?aspectRatio=1.78&format=webp&width=1200", synopsis:"The ultimate showdown.", cast:"Robert Downey Jr., Chris Evans", runtime:"3h 2m"},
    {id:6, title:"Avengers: Infinity War", genre:"Action", rating:4.8, price:15.50, image:"https://cdn.marvel.com/content/2x/avengersinfinitywar_lob_mas_hlf_01_3.jpg", synopsis:"Thanos threatens the universe.", cast:"Chris Hemsworth, Mark Ruffalo", runtime:"2h 40m"},
    {id:7, title:"The Avengers", genre:"Action", rating:4.7, price:12.99, image:"https://m.media-amazon.com/images/M/MV5BNGE0YTVjNzUtNzJjOS00NGNlLTgxMzctZTY4YTE1Y2Y1ZTU4XkEyXkFqcGc@._V1_.jpg", synopsis:"Earth's mightiest heroes unite.", cast:"Robert Downey Jr., Chris Evans", runtime:"2h 23m"},
    {id:8, title:"X-Men: Days of Future Past", genre:"Action", rating:4.6, price:13.50, image:"https://m.media-amazon.com/images/M/MV5BNzNiYWE4NjMtMTU4OS00NmM4LWE4ZjAtYmE5OTA5NjkzODExXkEyXkFqcGc@._V1_FMjpg_UX1000_.jpg", synopsis:"Mutants fight for the future.", cast:"Hugh Jackman, James McAvoy", runtime:"2h 11m"}
];

const defaultTheaters = ["Lubbock","Amarillo","Levelland","Plainview","Snyder","Abilene"];
const defaultShowtimes = [
    {name:"Morning", time:"10:00 AM"},
    {name:"Afternoon", time:"2:00 PM"},
    {name:"Evening", time:"6:00 PM"}
];

// Load shared data
let adminMovies = JSON.parse(localStorage.getItem(STORAGE_KEYS.MOVIES) || 'null') || defaultMovies;
let adminTheaters = JSON.parse(localStorage.getItem(STORAGE_KEYS.THEATERS) || 'null') || defaultTheaters;
let adminShowtimes = JSON.parse(localStorage.getItem(STORAGE_KEYS.SHOWTIMES) || 'null') || defaultShowtimes;

// Save initial data if not exists
if (!localStorage.getItem(STORAGE_KEYS.MOVIES)) {
    localStorage.setItem(STORAGE_KEYS.MOVIES, JSON.stringify(adminMovies));
}
if (!localStorage.getItem(STORAGE_KEYS.THEATERS)) {
    localStorage.setItem(STORAGE_KEYS.THEATERS, JSON.stringify(adminTheaters));
}
if (!localStorage.getItem(STORAGE_KEYS.SHOWTIMES)) {
    localStorage.setItem(STORAGE_KEYS.SHOWTIMES, JSON.stringify(adminShowtimes));
}

// Pagination
let currentPage = 1;
const itemsPerPage = 10;

// Chart instances
let charts = {};

function showSection(id){
    document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    
    if(id === 'dashboard') renderDashboard();
    else if(id === 'ticketHistory') {
        populateFilters();
        renderTickets();
    }
    else if(id === 'movieRevenue') renderMovieRevenue();
    else if(id === 'theaterAnalytics') renderTheaterAnalytics();
    else if(id === 'timeAnalytics') renderTimeAnalytics();
    else if(id === 'manageTheaters') {
        renderTheatersList();
        renderShowtimesList();
    }
    else if(id === 'manageAdmins') {
        populatePromoteSelect();
        renderAdminsList();
    }
    else if(id === 'registeredUsers') {
        renderUsersList();
    }
}

function getTickets() {
    return JSON.parse(localStorage.getItem(STORAGE_KEYS.TICKETS) || '[]');
}

function destroyChart(chartId) {
    if (charts[chartId]) {
        charts[chartId].destroy();
        delete charts[chartId];
    }
}

function renderDashboard() {
    const tickets = getTickets();
    
    const totalTickets = tickets.reduce((sum, t) => sum + t.quantity, 0);
    document.getElementById('totalTickets').innerText = totalTickets;
    
    const totalRevenue = tickets.reduce((sum, t) => {
        const price = t.price || moviePrices[t.movie] || 0;
        return sum + (price * t.quantity);
    }, 0);
    document.getElementById('totalRevenue').innerText = totalRevenue.toFixed(2);
    
    const uniqueMovies = new Set(tickets.map(t => t.movie)).size;
    document.getElementById('uniqueMovies').innerText = uniqueMovies;
    
    const avgPrice = totalTickets > 0 ? totalRevenue / totalTickets : 0;
    document.getElementById('avgTicketPrice').innerText = avgPrice.toFixed(2);
    
    const movieStats = {};
    tickets.forEach(t => {
        const price = t.price || moviePrices[t.movie] || 0;
        if(!movieStats[t.movie]) {
            movieStats[t.movie] = { tickets: 0, revenue: 0 };
        }
        movieStats[t.movie].tickets += t.quantity;
        movieStats[t.movie].revenue += price * t.quantity;
    });
    
    const topMoviesHtml = Object.entries(movieStats)
        .sort((a, b) => b[1].revenue - a[1].revenue)
        .slice(0, 5)
        .map(([movie, stats], idx) => `
            <div class="flex justify-between items-center p-3 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg">
                <div>
                    <span class="font-bold text-lg">${idx + 1}. ${movie}</span>
                    <span class="text-gray-600 text-sm ml-2">(${stats.tickets} tickets)</span>
                </div>
                <span class="font-black text-green-600 text-xl">$${stats.revenue.toFixed(2)}</span>
            </div>
        `).join('');
    document.getElementById('topMovies').innerHTML = topMoviesHtml || '<p class="text-gray-500">No sales yet</p>';
    
    renderCharts(tickets, movieStats);
}

function renderCharts(tickets, movieStats) {
    destroyChart('movieRevenueChart');
    const movieData = Object.entries(movieStats)
        .sort((a, b) => b[1].revenue - a[1].revenue)
        .slice(0, 8);
    
    const ctx1 = document.getElementById('movieRevenueChart').getContext('2d');
    charts['movieRevenueChart'] = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: movieData.map(m => m[0]),
            datasets: [{
                label: 'Revenue ($)',
                data: movieData.map(m => m[1].revenue),
                backgroundColor: 'rgba(74, 144, 226, 0.8)',
                borderColor: 'rgba(74, 144, 226, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
    
    destroyChart('theaterChart');
    const theaterStats = {};
    tickets.forEach(t => {
        if(!theaterStats[t.theater]) theaterStats[t.theater] = 0;
        const price = t.price || moviePrices[t.movie] || 0;
        theaterStats[t.theater] += price * t.quantity;
    });
    
    const ctx2 = document.getElementById('theaterChart').getContext('2d');
    charts['theaterChart'] = new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: Object.keys(theaterStats),
            datasets: [{
                data: Object.values(theaterStats),
                backgroundColor: [
                    'rgba(74, 144, 226, 0.8)',
                    'rgba(120, 119, 198, 0.8)',
                    'rgba(255, 138, 101, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(245, 158, 11, 0.8)'
                ]
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
    
    destroyChart('showtimeChart');
    const showtimeStats = {};
    tickets.forEach(t => {
        if(!showtimeStats[t.showtime]) showtimeStats[t.showtime] = 0;
        showtimeStats[t.showtime] += t.quantity;
    });
    
    const ctx3 = document.getElementById('showtimeChart').getContext('2d');
    charts['showtimeChart'] = new Chart(ctx3, {
        type: 'pie',
        data: {
            labels: Object.keys(showtimeStats),
            datasets: [{
                data: Object.values(showtimeStats),
                backgroundColor: [
                    'rgba(74, 144, 226, 0.8)',
                    'rgba(120, 119, 198, 0.8)',
                    'rgba(255, 138, 101, 0.8)'
                ]
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
    
    destroyChart('paymentChart');
    const paymentStats = {};
    tickets.forEach(t => {
        if(!paymentStats[t.paymentMethod]) paymentStats[t.paymentMethod] = 0;
        const price = t.price || moviePrices[t.movie] || 0;
        paymentStats[t.paymentMethod] += price * t.quantity;
    });
    
    const ctx4 = document.getElementById('paymentChart').getContext('2d');
    charts['paymentChart'] = new Chart(ctx4, {
        type: 'bar',
        data: {
            labels: Object.keys(paymentStats),
            datasets: [{
                label: 'Revenue ($)',
                data: Object.values(paymentStats),
                backgroundColor: 'rgba(120, 119, 198, 0.8)',
                borderColor: 'rgba(120, 119, 198, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
}

function populateFilters() {
    const tickets = getTickets();
    const theaters = [...new Set(tickets.map(t => t.theater))];
    const theaterSelect = document.getElementById('filterTheaterTicket');
    theaterSelect.innerHTML = '<option value="">All Theaters</option>' + 
        theaters.map(t => `<option value="${t}">${t}</option>`).join('');
    
    const showtimes = [...new Set(tickets.map(t => t.showtime))];
    const showtimeSelect = document.getElementById('filterShowtimeTicket');
    showtimeSelect.innerHTML = '<option value="">All Showtimes</option>' + 
        showtimes.map(s => `<option value="${s}">${s}</option>`).join('');
}

function renderTickets() {
    let tickets = getTickets().reverse();
    const searchTerm = document.getElementById('searchTicket')?.value.toLowerCase() || '';
    const theaterFilter = document.getElementById('filterTheaterTicket')?.value || '';
    const showtimeFilter = document.getElementById('filterShowtimeTicket')?.value || '';
    
    tickets = tickets.filter(t => {
        const matchesSearch = t.movie.toLowerCase().includes(searchTerm) ||
            t.theater.toLowerCase().includes(searchTerm) ||
            t.ticketId.toLowerCase().includes(searchTerm);
        const matchesTheater = !theaterFilter || t.theater === theaterFilter;
        const matchesShowtime = !showtimeFilter || t.showtime === showtimeFilter;
        return matchesSearch && matchesTheater && matchesShowtime;
    });
    
    const container = document.getElementById('ticketHistoryContainer');
    
    if(tickets.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">No tickets found</p>';
        document.getElementById('ticketPagination').innerHTML = '';
        return;
    }
    
    const totalPages = Math.ceil(tickets.length / itemsPerPage);
    const startIdx = (currentPage - 1) * itemsPerPage;
    const endIdx = startIdx + itemsPerPage;
    const paginatedTickets = tickets.slice(startIdx, endIdx);
    
    const table = document.createElement('table');
    table.innerHTML = `
        <thead>
            <tr>
                <th>Ticket ID</th>
                <th>Movie</th>
                <th>Theater</th>
                <th>Showtime</th>
                <th>Quantity</th>
                <th>Price/Ticket</th>
                <th>Total Revenue</th>
                <th>Payment</th>
                <th>Purchase Date</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    
    const tbody = table.querySelector('tbody');
    paginatedTickets.forEach(t => {
        const price = t.price || moviePrices[t.movie] || 0;
        const total = price * t.quantity;
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="font-mono text-xs">${t.ticketId}</td>
            <td><strong>${t.movie}</strong><br><span class="text-sm text-gray-600">${t.genre || 'N/A'}</span></td>
            <td>${t.theater || 'N/A'}</td>
            <td>${t.showtime || 'N/A'}</td>
            <td class="text-center font-bold">${t.quantity}</td>
            <td>${price.toFixed(2)}</td>
            <td class="font-bold text-green-600">${total.toFixed(2)}</td>
            <td>${t.paymentMethod || 'N/A'}</td>
            <td class="text-sm">${t.purchaseDate || 'N/A'}</td>
        `;
        tbody.appendChild(tr);
    });
    
    container.innerHTML = '';
    container.appendChild(table);
    renderPagination(totalPages);
}

function renderPagination(totalPages) {
    const container = document.getElementById('ticketPagination');
    container.innerHTML = '';
    if (totalPages <= 1) return;
    
    const prevBtn = document.createElement('button');
    prevBtn.className = 'pagination-btn';
    prevBtn.innerText = '‚Üê Previous';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            renderTickets();
        }
    };
    container.appendChild(prevBtn);
    
    const maxVisible = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);
    if (endPage - startPage < maxVisible - 1) {
        startPage = Math.max(1, endPage - maxVisible + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = 'pagination-btn' + (i === currentPage ? ' active' : '');
        pageBtn.innerText = i;
        pageBtn.onclick = () => {
            currentPage = i;
            renderTickets();
        };
        container.appendChild(pageBtn);
    }
    
    const nextBtn = document.createElement('button');
    nextBtn.className = 'pagination-btn';
    nextBtn.innerText = 'Next ‚Üí';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => {
        if (currentPage < totalPages) {
            currentPage++;
            renderTickets();
        }
    };
    container.appendChild(nextBtn);
}

function clearTicketFilters() {
    document.getElementById('searchTicket').value = '';
    document.getElementById('filterTheaterTicket').value = '';
    document.getElementById('filterShowtimeTicket').value = '';
    currentPage = 1;
    renderTickets();
}

function renderMovieRevenue() {
    const tickets = getTickets();
    const container = document.getElementById('movieRevenueContainer');
    
    const movieData = {};
    tickets.forEach(t => {
        if(!movieData[t.movie]) {
            movieData[t.movie] = {
                title: t.movie,
                genre: t.genre,
                ticketsSold: 0,
                revenue: 0,
                theaters: {},
                showtimes: {},
                payments: {}
            };
        }
        
        const price = t.price || moviePrices[t.movie] || 0;
        movieData[t.movie].ticketsSold += t.quantity;
        movieData[t.movie].revenue += price * t.quantity;
        
        if(!movieData[t.movie].theaters[t.theater]) movieData[t.movie].theaters[t.theater] = 0;
        movieData[t.movie].theaters[t.theater] += t.quantity;
        
        if(!movieData[t.movie].showtimes[t.showtime]) movieData[t.movie].showtimes[t.showtime] = 0;
        movieData[t.movie].showtimes[t.showtime] += t.quantity;
        
        if(!movieData[t.movie].payments[t.paymentMethod]) movieData[t.movie].payments[t.paymentMethod] = 0;
        movieData[t.movie].payments[t.paymentMethod] += t.quantity;
    });
    
    const sortedMovies = Object.values(movieData).sort((a, b) => b.revenue - a.revenue);
    
    if(sortedMovies.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">No revenue data yet</p>';
        return;
    }
    
    const table = document.createElement('table');
    table.innerHTML = `
        <thead>
            <tr>
                <th>Movie</th>
                <th>Tickets Sold</th>
                <th>Revenue</th>
                <th>Theaters (Tickets)</th>
                <th>Showtimes (Tickets)</th>
                <th>Payment Methods (Tickets)</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    
    const tbody = table.querySelector('tbody');
    sortedMovies.forEach(m => {
        const theaterStr = Object.entries(m.theaters)
            .sort((a, b) => b[1] - a[1])
            .map(([theater, count]) => `${theater}: ${count}`)
            .join('<br>');
        
        const showtimeStr = Object.entries(m.showtimes)
            .sort((a, b) => b[1] - a[1])
            .map(([time, count]) => `${time}: ${count}`)
            .join('<br>');
        
        const paymentStr = Object.entries(m.payments)
            .sort((a, b) => b[1] - a[1])
            .map(([method, count]) => `${method}: ${count}`)
            .join('<br>');
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong>${m.title}</strong><br><span class="text-sm text-gray-600">${m.genre}</span></td>
            <td class="text-center font-bold text-lg">${m.ticketsSold}</td>
            <td class="font-bold text-green-600 text-lg">${m.revenue.toFixed(2)}</td>
            <td class="text-sm">${theaterStr}</td>
            <td class="text-sm">${showtimeStr}</td>
            <td class="text-sm">${paymentStr}</td>
        `;
        tbody.appendChild(tr);
    });
    
    container.innerHTML = '';
    container.appendChild(table);
}

function renderTheaterAnalytics() {
    const tickets = getTickets();
    const container = document.getElementById('theaterAnalyticsContainer');
    
    const theaterData = {};
    tickets.forEach(t => {
        if(!theaterData[t.theater]) {
            theaterData[t.theater] = {
                theater: t.theater,
                ticketsSold: 0,
                revenue: 0,
                movies: {},
                showtimes: {}
            };
        }
        
        const price = t.price || moviePrices[t.movie] || 0;
        theaterData[t.theater].ticketsSold += t.quantity;
        theaterData[t.theater].revenue += price * t.quantity;
        
        if(!theaterData[t.theater].movies[t.movie]) theaterData[t.theater].movies[t.movie] = 0;
        theaterData[t.theater].movies[t.movie] += t.quantity;
        
        if(!theaterData[t.theater].showtimes[t.showtime]) theaterData[t.theater].showtimes[t.showtime] = 0;
        theaterData[t.theater].showtimes[t.showtime] += t.quantity;
    });
    
    const sortedTheaters = Object.values(theaterData).sort((a, b) => b.revenue - a.revenue);
    
    if(sortedTheaters.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">No theater data yet</p>';
        return;
    }
    
    const table = document.createElement('table');
    table.innerHTML = `
        <thead>
            <tr>
                <th>Theater</th>
                <th>Tickets Sold</th>
                <th>Revenue</th>
                <th>Top Movies (Tickets)</th>
                <th>Showtime Performance (Tickets)</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    
    const tbody = table.querySelector('tbody');
    sortedTheaters.forEach(t => {
        const moviesStr = Object.entries(t.movies)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .map(([movie, count]) => `${movie}: ${count}`)
            .join('<br>');
        
        const showtimesStr = Object.entries(t.showtimes)
            .sort((a, b) => b[1] - a[1])
            .map(([time, count]) => `${time}: ${count}`)
            .join('<br>');
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong class="text-lg">${t.theater}</strong></td>
            <td class="text-center font-bold text-lg">${t.ticketsSold}</td>
            <td class="font-bold text-green-600 text-lg">${t.revenue.toFixed(2)}</td>
            <td class="text-sm">${moviesStr}</td>
            <td class="text-sm">${showtimesStr}</td>
        `;
        tbody.appendChild(tr);
    });
    
    container.innerHTML = '';
    container.appendChild(table);
}

function renderTimeAnalytics() {
    const tickets = getTickets();
    const container = document.getElementById('timeAnalyticsContainer');
    
    const timeData = {};
    tickets.forEach(t => {
        if(!timeData[t.showtime]) {
            timeData[t.showtime] = {
                showtime: t.showtime,
                ticketsSold: 0,
                revenue: 0,
                movies: {},
                theaters: {}
            };
        }
        
        const price = t.price || moviePrices[t.movie] || 0;
        timeData[t.showtime].ticketsSold += t.quantity;
        timeData[t.showtime].revenue += price * t.quantity;
        
        if(!timeData[t.showtime].movies[t.movie]) timeData[t.showtime].movies[t.movie] = 0;
        timeData[t.showtime].movies[t.movie] += t.quantity;
        
        if(!timeData[t.showtime].theaters[t.theater]) timeData[t.showtime].theaters[t.theater] = 0;
        timeData[t.showtime].theaters[t.theater] += t.quantity;
    });
    
    const sortedTimes = Object.values(timeData).sort((a, b) => b.revenue - a.revenue);
    
    if(sortedTimes.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">No showtime data yet</p>';
        return;
    }
    
    const table = document.createElement('table');
    table.innerHTML = `
        <thead>
            <tr>
                <th>Showtime</th>
                <th>Tickets Sold</th>
                <th>Revenue</th>
                <th>Top Movies (Tickets)</th>
                <th>Theater Distribution (Tickets)</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    
    const tbody = table.querySelector('tbody');
    sortedTimes.forEach(t => {
        const moviesStr = Object.entries(t.movies)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .map(([movie, count]) => `${movie}: ${count}`)
            .join('<br>');
        
        const theatersStr = Object.entries(t.theaters)
            .sort((a, b) => b[1] - a[1])
            .map(([theater, count]) => `${theater}: ${count}`)
            .join('<br>');
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong class="text-lg">${t.showtime}</strong></td>
            <td class="text-center font-bold text-lg">${t.ticketsSold}</td>
            <td class="font-bold text-green-600 text-lg">${t.revenue.toFixed(2)}</td>
            <td class="text-sm">${moviesStr}</td>
            <td class="text-sm">${theatersStr}</td>
        `;
        tbody.appendChild(tr);
    });
    
    container.innerHTML = '';
    container.appendChild(table);
}

// Theater Management
function addTheater() {
    const name = document.getElementById('newTheaterName').value.trim();
    
    if (!name) {
        alert('Please enter a theater name');
        return;
    }
    
    if (adminTheaters.some(t => t.toLowerCase() === name.toLowerCase())) {
        alert('This theater already exists!');
        return;
    }
    
    adminTheaters.push(name);
    localStorage.setItem(STORAGE_KEYS.THEATERS, JSON.stringify(adminTheaters));
    
    document.getElementById('newTheaterName').value = '';
    alert('Theater added successfully! It will now appear on the home screen.');
    renderTheatersList();
}

function renderTheatersList() {
    const container = document.getElementById('theatersListContainer');
    const searchTerm = document.getElementById('searchTheaters')?.value.toLowerCase() || '';
    
    const filteredTheaters = adminTheaters.filter(t => 
        t.toLowerCase().includes(searchTerm)
    );
    
    if (filteredTheaters.length === 0) {
        container.innerHTML = '<p class="text-gray-500">No theaters found.</p>';
        return;
    }
    
    container.innerHTML = filteredTheaters.map(theater => {
        const actualIdx = adminTheaters.indexOf(theater);
        return `
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition">
            <span class="font-bold">üé≠ ${theater}</span>
            <div class="flex gap-2">
                <button onclick="editTheater(${actualIdx})" class="btn-primary px-4 py-2 rounded-xl text-sm">‚úèÔ∏è Edit</button>
                <button onclick="deleteTheater(${actualIdx})" class="btn-danger px-4 py-2 rounded-xl text-sm">üóëÔ∏è Delete</button>
            </div>
        </div>
    `}).join('');
}

function editTheater(idx) {
    const theater = adminTheaters[idx];
    document.getElementById('editTheaterId').value = idx;
    document.getElementById('editTheaterName').value = theater;
    document.getElementById('editTheaterModal').classList.add('active');
}

function saveTheaterEdit() {
    const idx = parseInt(document.getElementById('editTheaterId').value);
    const name = document.getElementById('editTheaterName').value.trim();
    
    if (!name) {
        alert('Please enter a theater name');
        return;
    }
    
    // Check for duplicate (excluding current)
    if (adminTheaters.some((t, i) => i !== idx && t.toLowerCase() === name.toLowerCase())) {
        alert('A theater with this name already exists!');
        return;
    }
    
    adminTheaters[idx] = name;
    localStorage.setItem(STORAGE_KEYS.THEATERS, JSON.stringify(adminTheaters));
    
    closeTheaterModal();
    alert('Theater updated successfully! Changes will appear on the home screen.');
    renderTheatersList();
}

function closeTheaterModal() {
    document.getElementById('editTheaterModal').classList.remove('active');
}

function deleteTheater(idx) {
    const theater = adminTheaters[idx];
    if (!confirm(`Are you sure you want to delete "${theater}"? This action cannot be undone.`)) return;
    
    adminTheaters.splice(idx, 1);
    localStorage.setItem(STORAGE_KEYS.THEATERS, JSON.stringify(adminTheaters));
    
    alert('Theater deleted successfully! It will be removed from the home screen.');
    renderTheatersList();
}

// Showtime Management
function addShowtime() {
    const name = document.getElementById('newShowtimeName').value.trim();
    const time = document.getElementById('newShowtimeTime').value.trim();
    
    if (!name || !time) {
        alert('Please enter both showtime name and time');
        return;
    }
    
    // Check for duplicate
    if (adminShowtimes.some(s => s.name.toLowerCase() === name.toLowerCase())) {
        alert('A showtime with this name already exists!');
        return;
    }
    
    adminShowtimes.push({ name, time });
    localStorage.setItem(STORAGE_KEYS.SHOWTIMES, JSON.stringify(adminShowtimes));
    
    document.getElementById('newShowtimeName').value = '';
    document.getElementById('newShowtimeTime').value = '';
    alert('Showtime added successfully! It will now appear on the home screen.');
    renderShowtimesList();
}

function renderShowtimesList() {
    const container = document.getElementById('showtimesListContainer');
    const searchTerm = document.getElementById('searchShowtimes')?.value.toLowerCase() || '';
    
    const filteredShowtimes = adminShowtimes.filter(s => 
        s.name.toLowerCase().includes(searchTerm) ||
        s.time.toLowerCase().includes(searchTerm)
    );
    
    if (filteredShowtimes.length === 0) {
        container.innerHTML = '<p class="text-gray-500">No showtimes found.</p>';
        return;
    }
    
    container.innerHTML = filteredShowtimes.map(showtime => {
        const actualIdx = adminShowtimes.findIndex(s => s.name === showtime.name);
        return `
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition">
            <div>
                <span class="font-bold">üïê ${showtime.name}</span>
                <span class="text-gray-600 ml-2">(${showtime.time})</span>
            </div>
            <div class="flex gap-2">
                <button onclick="editShowtime(${actualIdx})" class="btn-primary px-4 py-2 rounded-xl text-sm">‚úèÔ∏è Edit</button>
                <button onclick="deleteShowtime(${actualIdx})" class="btn-danger px-4 py-2 rounded-xl text-sm">üóëÔ∏è Delete</button>
            </div>
        </div>
    `}).join('');
}

function editShowtime(idx) {
    const showtime = adminShowtimes[idx];
    document.getElementById('editShowtimeId').value = idx;
    document.getElementById('editShowtimeName').value = showtime.name;
    document.getElementById('editShowtimeTime').value = showtime.time;
    document.getElementById('editShowtimeModal').classList.add('active');
}

function saveShowtimeEdit() {
    const idx = parseInt(document.getElementById('editShowtimeId').value);
    const name = document.getElementById('editShowtimeName').value.trim();
    const time = document.getElementById('editShowtimeTime').value.trim();
    
    if (!name || !time) {
        alert('Please enter both showtime name and time');
        return;
    }
    
    // Check for duplicate (excluding current)
    if (adminShowtimes.some((s, i) => i !== idx && s.name.toLowerCase() === name.toLowerCase())) {
        alert('A showtime with this name already exists!');
        return;
    }
    
    adminShowtimes[idx] = { name, time };
    localStorage.setItem(STORAGE_KEYS.SHOWTIMES, JSON.stringify(adminShowtimes));
    
    closeShowtimeModal();
    alert('Showtime updated successfully! Changes will appear on the home screen.');
    renderShowtimesList();
}

function closeShowtimeModal() {
    document.getElementById('editShowtimeModal').classList.remove('active');
}

function deleteShowtime(idx) {
    const showtime = adminShowtimes[idx];
    if (!confirm(`Are you sure you want to delete "${showtime.name}"? This action cannot be undone.`)) return;
    
    adminShowtimes.splice(idx, 1);
    localStorage.setItem(STORAGE_KEYS.SHOWTIMES, JSON.stringify(adminShowtimes));
    
    alert('Showtime deleted successfully! It will be removed from the home screen.');
    renderShowtimesList();
}

// =============================================
// USER MANAGEMENT
// =============================================

function populatePromoteSelect() {
    const select = document.getElementById('promoteUserSelect');
    const regularUsers = getRegularUsers();
    
    select.innerHTML = '<option value="">Select a user to promote...</option>' +
        regularUsers.map(u => `<option value="${u.userId}">${u.name} (${u.email})</option>`).join('');
}

function promoteToAdmin() {
    // Require admin authentication
    try {
        requireAdminAuth();
    } catch (error) {
        return;
    }
    
    const select = document.getElementById('promoteUserSelect');
    const userId = select.value;
    
    if (!userId) {
        alert('Please select a user to promote');
        return;
    }
    
    const user = getRegularUsers().find(u => u.userId === userId);
    if (!user) {
        alert('User not found');
        return;
    }
    
    if (!confirm(`Are you sure you want to promote "${user.name}" to admin status?\n\n‚ö†Ô∏è Admins have full access to:\n‚Ä¢ Create/manage other admins\n‚Ä¢ Manage all users\n‚Ä¢ Access all system data\n‚Ä¢ Modify theaters and showtimes`)) return;
    
    // Update in SQL database
    const updated = updateUserInSQL(userId, { accountType: 'admin' });
    
    if (updated) {
        alert(`‚úÖ ${user.name} has been promoted to admin!\n\nThey can now:\n‚Ä¢ Access the admin panel\n‚Ä¢ Create other admins\n‚Ä¢ Manage users and system settings`);
        populatePromoteSelect();
        renderAdminsList();
    } else {
        alert('Failed to promote user. Please try again.');
    }
}

function addAdmin() {
    // Require admin authentication
    try {
        requireAdminAuth();
    } catch (error) {
        return;
    }
    
    const name = document.getElementById('newAdminName').value.trim();
    const email = document.getElementById('newAdminEmail').value.trim().toLowerCase();
    const password = document.getElementById('newAdminPassword').value;
    const phone = document.getElementById('newAdminPhone').value.trim();
    
    if (!name || !email || !password) {
        alert('Please fill in all required fields (Name, Email, Password)');
        return;
    }
    
    // Basic email validation
    if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        alert('Please enter a valid email address');
        return;
    }
    
    if (password.length < 6) {
        alert('Password must be at least 6 characters');
        return;
    }
    
    // Check for duplicate email in SQL database
    if (emailExistsInSQL(email)) {
        alert('An account with this email already exists!');
        return;
    }
    
    const userId = generateUserId();
    const newAdmin = {
        userId: userId,
        name: name,
        email: email,
        phone: phone || '',
        address: '',
        passwordHash: hashPassword(password),
        accountType: 'admin',
        signupDate: new Date().toISOString()
    };
    
    // Insert into SQL database
    const inserted = insertUserIntoSQL(newAdmin);
    
    if (inserted) {
        // Clear form
        document.getElementById('newAdminName').value = '';
        document.getElementById('newAdminEmail').value = '';
        document.getElementById('newAdminPassword').value = '';
        document.getElementById('newAdminPhone').value = '';
        
        alert(`‚úÖ Admin account created successfully!\n\nüë§ Name: ${name}\nüìß Email: ${email}\nüëë Role: Administrator\n\nThe new admin can now:\n‚Ä¢ Log in using their credentials\n‚Ä¢ Access the admin panel\n‚Ä¢ Create other admins\n‚Ä¢ Manage all users and settings`);
        renderAdminsList();
    } else {
        alert('Failed to create admin account. Please try again.');
    }
}

function renderAdminsList() {
    const container = document.getElementById('adminsListContainer');
    const searchTerm = document.getElementById('searchAdmins')?.value.toLowerCase() || '';
    
    const adminUsers = getAdminUsers();
    
    const filteredAdmins = adminUsers.filter(u => 
        u.name.toLowerCase().includes(searchTerm) ||
        u.email.toLowerCase().includes(searchTerm) ||
        (u.phone && u.phone.toLowerCase().includes(searchTerm))
    );
    
    // Update admin count
    document.getElementById('adminCount').textContent = adminUsers.length;
    
    if (filteredAdmins.length === 0) {
        container.innerHTML = '<p class="text-gray-500">No admins found.</p>';
        return;
    }
    
    container.innerHTML = filteredAdmins.map(admin => `
        <div class="flex justify-between items-center p-4 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl hover:from-purple-100 hover:to-blue-100 transition border-l-4 border-purple-500">
            <div>
                <h4 class="font-bold text-lg">üëë ${admin.name}</h4>
                <p class="text-sm text-gray-600">Email: ${admin.email}</p>
                <p class="text-sm text-gray-600">Phone: ${admin.phone || 'Not provided'}</p>
                <p class="text-sm text-gray-600">Admin since: ${new Date(admin.signupDate).toLocaleDateString()}</p>
            </div>
            <div class="flex gap-2">
                <button onclick="demoteFromAdmin('${admin.userId}')" class="btn-danger px-4 py-2 rounded-xl text-sm">‚¨áÔ∏è Demote to User</button>
            </div>
        </div>
    `).join('');
}

function demoteFromAdmin(userId) {
    // Require admin authentication
    try {
        requireAdminAuth();
    } catch (error) {
        return;
    }
    
    const admin = getAdminUsers().find(u => u.userId === userId);
    if (!admin) {
        alert('Admin not found');
        return;
    }
    
    // Prevent demoting yourself
    const currentSession = JSON.parse(localStorage.getItem('currentUser'));
    if (currentSession.userId === userId) {
        alert('‚ö†Ô∏è You cannot demote yourself!\n\nIf you need to change your role, please ask another admin to do it.');
        return;
    }
    
    if (!confirm(`Are you sure you want to demote "${admin.name}" from admin to regular user?\n\n‚ö†Ô∏è They will lose access to:\n‚Ä¢ Admin panel\n‚Ä¢ User management\n‚Ä¢ System settings`)) return;
    
    // Update in SQL database
    const updated = updateUserInSQL(userId, { accountType: 'user' });
    
    if (updated) {
        alert(`‚úÖ ${admin.name} has been demoted to regular user.\n\nThey can still:\n‚Ä¢ Log in to their account\n‚Ä¢ Book movie tickets\n‚Ä¢ View their profile`);
        populatePromoteSelect();
        renderAdminsList();
    } else {
        alert('Failed to demote admin. Please try again.');
    }
}

// =============================================
// REGISTERED USERS MANAGEMENT
// =============================================

function addUser() {
    // Require admin authentication
    try {
        requireAdminAuth();
    } catch (error) {
        return;
    }
    
    const name = document.getElementById('newUserName').value.trim();
    const email = document.getElementById('newUserEmail').value.trim().toLowerCase();
    const password = document.getElementById('newUserPassword').value;
    const phone = document.getElementById('newUserPhone').value.trim();
    
    if (!name || !email || !password) {
        alert('Please fill in all required fields (Name, Email, Password)');
        return;
    }
    
    // Basic email validation
    if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        alert('Please enter a valid email address');
        return;
    }
    
    if (password.length < 6) {
        alert('Password must be at least 6 characters');
        return;
    }
    
    // Check for duplicate email in SQL database
    if (emailExistsInSQL(email)) {
        alert('An account with this email already exists!');
        return;
    }
    
    const userId = generateUserId();
    const newUser = {
        userId: userId,
        name: name,
        email: email,
        phone: phone || '',
        address: '',
        passwordHash: hashPassword(password),
        accountType: 'user',
        signupDate: new Date().toISOString()
    };
    
    // Insert into SQL database
    const inserted = insertUserIntoSQL(newUser);
    
    if (inserted) {
        // Clear form
        document.getElementById('newUserName').value = '';
        document.getElementById('newUserEmail').value = '';
        document.getElementById('newUserPassword').value = '';
        document.getElementById('newUserPhone').value = '';
        
        alert(`‚úÖ User added successfully!\n\nüë§ Name: ${name}\nüìß Email: ${email}\nüé´ Role: Regular User\n\nThe user can now:\n‚Ä¢ Log in to book movie tickets\n‚Ä¢ View their profile\n‚Ä¢ Access the home screen`);
        renderUsersList();
    } else {
        alert('Failed to add user. Please try again.');
    }
}

function renderUsersList() {
    const container = document.getElementById('usersListContainer');
    const searchTerm = document.getElementById('searchUsers')?.value.toLowerCase() || '';
    
    const regularUsers = getRegularUsers();
    
    const filteredUsers = regularUsers.filter(u => 
        u.name.toLowerCase().includes(searchTerm) ||
        u.email.toLowerCase().includes(searchTerm) ||
        (u.phone && u.phone.toLowerCase().includes(searchTerm))
    );
    
    // Update user count
    document.getElementById('userCount').textContent = regularUsers.length;
    
    if (filteredUsers.length === 0) {
        container.innerHTML = '<p class="text-gray-500">No users found.</p>';
        return;
    }
    
    container.innerHTML = filteredUsers.map(user => `
        <div class="flex justify-between items-center p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition">
            <div>
                <h4 class="font-bold text-lg">üë§ ${user.name}</h4>
                <p class="text-sm text-gray-600">Email: ${user.email}</p>
                <p class="text-sm text-gray-600">Phone: ${user.phone || 'Not provided'}</p>
                <p class="text-sm text-gray-600">Signed up: ${new Date(user.signupDate).toLocaleDateString()}</p>
            </div>
            <div class="flex gap-2">
                <button onclick="editUser('${user.userId}')" class="btn-primary px-4 py-2 rounded-xl text-sm">‚úèÔ∏è Edit</button>
                <button onclick="deleteUser('${user.userId}')" class="btn-danger px-4 py-2 rounded-xl text-sm">üóëÔ∏è Delete</button>
            </div>
        </div>
    `).join('');
}

function editUser(userId) {
    // Require admin authentication
    try {
        requireAdminAuth();
    } catch (error) {
        return;
    }
    
    const allUsers = getAllUsersFromSQL();
    const user = allUsers.find(u => u.userId === userId);
    
    if (!user) {
        alert('User not found');
        return;
    }
    
    document.getElementById('editUserId').value = user.userId;
    document.getElementById('editUserName').value = user.name;
    document.getElementById('editUserEmail').value = user.email;
    document.getElementById('editUserPassword').value = '';  // Don't prefill password
    document.getElementById('editUserPhone').value = user.phone || '';
    document.getElementById('editUserSignupDate').value = new Date(user.signupDate).toLocaleString();
    
    document.getElementById('editUserModal').classList.add('active');
}

function saveUserEdit() {
    // Require admin authentication
    try {
        requireAdminAuth();
    } catch (error) {
        return;
    }
    
    const userId = document.getElementById('editUserId').value;
    const name = document.getElementById('editUserName').value.trim();
    const email = document.getElementById('editUserEmail').value.trim().toLowerCase();
    const password = document.getElementById('editUserPassword').value.trim();
    const phone = document.getElementById('editUserPhone').value.trim();
    
    if (!name || !email) {
        alert('Please fill in all required fields (Name and Email)');
        return;
    }
    
    if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        alert('Please enter a valid email address');
        return;
    }
    
    // Check for duplicate email (excluding current user)
    const allUsers = getAllUsersFromSQL();
    if (allUsers.some(u => u.userId !== userId && u.email.toLowerCase() === email)) {
        alert('A user with this email already exists!');
        return;
    }
    
    const updates = {
        name: name,
        email: email,
        phone: phone || ''
    };
    
    // Only update password if a new one is provided
    if (password) {
        if (password.length < 6) {
            alert('Password must be at least 6 characters');
            return;
        }
        updates.passwordHash = hashPassword(password);
    }
    
    // Update in SQL database
    const updated = updateUserInSQL(userId, updates);
    
    if (updated) {
        closeUserModal();
        alert('‚úÖ User updated successfully!');
        renderUsersList();
        renderAdminsList();
    } else {
        alert('Failed to update user. Please try again.');
    }
}

function closeUserModal() {
    document.getElementById('editUserModal').classList.remove('active');
}

function deleteUser(userId) {
    // Require admin authentication
    try {
        requireAdminAuth();
    } catch (error) {
        return;
    }
    
    const allUsers = getAllUsersFromSQL();
    const user = allUsers.find(u => u.userId === userId);
    
    if (!user) {
        alert('User not found');
        return;
    }
    
    // Prevent deleting yourself
    const currentSession = JSON.parse(localStorage.getItem('currentUser'));
    if (currentSession.userId === userId) {
        alert('‚ö†Ô∏è You cannot delete your own account!\n\nIf you need to delete your account, please ask another admin to do it.');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete "${user.name}" (${user.email})?\n\n‚ö†Ô∏è This action cannot be undone.\n\nAll user data will be permanently deleted including:\n‚Ä¢ Account information\n‚Ä¢ Purchase history\n‚Ä¢ Reviews`)) return;
    
    // Delete from SQL database
    const deleted = deleteUserFromSQL(userId);
    
    if (deleted) {
        alert('‚úÖ User deleted successfully!');
        renderUsersList();
        renderAdminsList();
    } else {
        alert('Failed to delete user. Please try again.');
    }
}

// Export Data
function exportData() {
    const tickets = getTickets();
    
    if (tickets.length === 0) {
        alert('No data to export');
        return;
    }
    
    const headers = ['Ticket ID', 'Movie', 'Genre', 'Theater', 'Showtime', 'Quantity', 'Price per Ticket', 'Total Revenue', 'Payment Method', 'Purchase Date'];
    const rows = tickets.map(t => {
        const price = t.price || moviePrices[t.movie] || 0;
        const total = price * t.quantity;
        return [
            t.ticketId,
            t.movie,
            t.genre,
            t.theater,
            t.showtime,
            t.quantity,
            price.toFixed(2),
            total.toFixed(2),
            t.paymentMethod,
            t.purchaseDate
        ];
    });
    
    let csvContent = headers.join(',') + '\n';
    rows.forEach(row => {
        csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ReelDeal_Cinema_Report_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    alert('Report exported successfully!');
}

// =============================================
// AUTHENTICATION & ACCESS CONTROL
// =============================================

function checkAdminAccess() {
    // Check if user is logged in
    const sessionData = localStorage.getItem('currentUser');
    
    if (!sessionData) {
        alert('‚õî Access Denied: Please log in to access the admin panel.');
        window.location.href = 'login.html';
        return false;
    }
    
    try {
        const currentUser = JSON.parse(sessionData);
        
        // Verify user is an admin
        if (currentUser.accountType !== 'admin') {
            alert('‚õî Access Denied: This area is restricted to administrators only.\n\nYou are logged in as a regular user and do not have permission to access the admin panel.');
            window.location.href = 'Home_Screen.html';
            return false;
        }
        
        // Display admin info in header
        displayAdminInfo(currentUser);
        return true;
        
    } catch (error) {
        console.error('Session validation error:', error);
        alert('‚õî Session error. Please log in again.');
        window.location.href = 'login.html';
        return false;
    }
}

function displayAdminInfo(adminUser) {
    // Add admin info to the header
    const header = document.querySelector('header');
    const adminInfoDiv = document.createElement('div');
    adminInfoDiv.className = 'mt-4 bg-purple-600 bg-opacity-30 backdrop-blur text-white px-4 py-2 rounded-xl inline-block';
    adminInfoDiv.innerHTML = `
        <span class="font-semibold">üëë Logged in as Admin:</span> 
        <span class="font-bold">${adminUser.name}</span> 
        <span class="opacity-75">(${adminUser.email})</span>
    `;
    header.appendChild(adminInfoDiv);
}

// Verify admin access throughout the session
function verifyAdminSession() {
    const sessionData = localStorage.getItem('currentUser');
    if (!sessionData) {
        alert('‚õî Your session has expired. Please log in again.');
        window.location.href = 'login.html';
        return false;
    }
    
    try {
        const currentUser = JSON.parse(sessionData);
        if (currentUser.accountType !== 'admin') {
            alert('‚õî Access Denied: Admin privileges required.');
            window.location.href = 'Home_Screen.html';
            return false;
        }
        return true;
    } catch (error) {
        window.location.href = 'login.html';
        return false;
    }
}

// Protect sensitive admin actions
function requireAdminAuth() {
    if (!verifyAdminSession()) {
        throw new Error('Admin authentication required');
    }
}

// Initialize database and show dashboard
window.addEventListener('DOMContentLoaded', async function() {
    // CRITICAL: Check admin access first
    if (!checkAdminAccess()) {
        return; // Exit if not authorized
    }
    
    const initialized = await initDatabase();
    if (initialized) {
        showSection('dashboard');
    } else {
        alert('Failed to initialize database. Please refresh the page.');
    }
});

// Check admin session periodically (every 30 seconds)
setInterval(() => {
    verifyAdminSession();
}, 30000);
</script>
</body>
</html>